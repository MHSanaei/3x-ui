<!DOCTYPE html>
<html lang="en">
{{template "head" .}}
<link rel="stylesheet" href="{{ .base_path }}assets/codemirror/codemirror.css?{{ .cur_ver }}">
<link rel="stylesheet" href="{{ .base_path }}assets/codemirror/fold/foldgutter.css">
<link rel="stylesheet" href="{{ .base_path }}assets/codemirror/xq.css?{{ .cur_ver }}">
<link rel="stylesheet" href="{{ .base_path }}assets/codemirror/lint/lint.css">

<script src="{{ .base_path }}assets/base64/base64.min.js"></script>
<script src="{{ .base_path }}assets/js/model/outbound.js?{{ .cur_ver }}"></script>
<script src="{{ .base_path }}assets/codemirror/codemirror.js?{{ .cur_ver }}"></script>
<script src="{{ .base_path }}assets/codemirror/javascript.js"></script>
<script src="{{ .base_path }}assets/codemirror/jshint.js"></script>
<script src="{{ .base_path }}assets/codemirror/jsonlint.js"></script>
<script src="{{ .base_path }}assets/codemirror/lint/lint.js"></script>
<script src="{{ .base_path }}assets/codemirror/lint/javascript-lint.js"></script>
<script src="{{ .base_path }}assets/codemirror/hint/javascript-hint.js"></script>
<script src="{{ .base_path }}assets/codemirror/fold/foldcode.js"></script>
<script src="{{ .base_path }}assets/codemirror/fold/foldgutter.js"></script>
<script src="{{ .base_path }}assets/codemirror/fold/brace-fold.js"></script>
<style>
    @media (min-width: 769px) {
        .ant-layout-content {
            margin: 24px 16px;
        }
    }

    @media (max-width: 768px) {
        .ant-tabs-nav .ant-tabs-tab {
            margin: 0;
            padding: 12px .5rem;
        }
        .ant-table-thead > tr > th,
        .ant-table-tbody > tr > td {
            padding: 10px 0px;
        }
    }

    .ant-tabs-bar {
        margin: 0;
    }

    .ant-list-item {
        display: block;
    }

    .collapse-title {
        color: inherit;
        font-weight: bold;
        font-size: 18px;
        padding: 10px 20px;
        border-bottom: 2px solid;
    }

    .collapse-title > i {
        color: inherit;
        font-size: 24px;
    }
</style>
<body>
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme">
    {{ template "commonSider" . }}
    <a-layout id="content-layout">
        <a-layout-content>
            <a-spin :spinning="spinning" :delay="500" tip='{{ i18n "loading"}}'>
                <transition name="list" appear>
                    <a-alert type="error" v-if="showAlert" style="margin-bottom: 10px"
                    message='{{ i18n "secAlertTitle" }}'
                    color="red"
                    description='{{ i18n "secAlertSsl" }}'
                    show-icon closable
                    >
                    </a-alert>
                </transition>
                <a-space direction="vertical">
                    <a-card hoverable style="margin-bottom: .5rem;">
                        <a-row style="display: flex; flex-wrap: wrap; align-items: center;">
                            <a-col :xs="24" :sm="10" style="padding: 4px;">
                                <a-space direction="horizontal">
                                    <a-button type="primary" :disabled="saveBtnDisable" @click="updateXraySetting">{{ i18n "pages.xray.save" }}</a-button>
                                    <a-button type="danger" :disabled="!saveBtnDisable" @click="restartXray">{{ i18n "pages.xray.restart" }}</a-button>
                                    <a-popover v-if="restartResult"
                                        :overlay-class-name="themeSwitcher.currentTheme">
                                        <span slot="title" style="font-size: 12pt">Error in running xray-core</span>
                                        <template slot="content">
                                            <p style="max-width: 400px" v-for="line in restartResult.split('\n')">[[ line ]]</p>
                                        </template>
                                        <a-icon type="question-circle"></a-icon>
                                    </a-popover>
                                </a-space>
                            </a-col>
                            <a-col :xs="24" :sm="14">
                                <template>
                                    <div>
                                        <a-back-top :target="() => document.getElementById('content-layout')" visibility-height="200">
                                        </a-back-top>
                                        <a-alert type="warning" style="float: right; width: fit-content"
                                        message='{{ i18n "pages.settings.infoDesc" }}'
                                        show-icon
                                        >
                                    </div>
                                </template>
                            </a-col>
                        </a-row>
                    </a-card>
                    <a-tabs class="ant-card-dark-box-nohover" default-active-key="1"
                    @change="(activeKey) => { this.changePage(activeKey); }"
                    :class="themeSwitcher.currentTheme">
                        <a-tab-pane key="tpl-basic" tab='{{ i18n "pages.xray.basicTemplate"}}' style="padding-top: 20px;">
                            <a-collapse>
                                <a-collapse-panel header='{{ i18n "pages.xray.generalConfigs"}}'>
                                    <a-row :xs="24" :sm="24" :lg="12">
                                        <a-alert type="warning" style="text-align: center;">
                                            <template slot="message">
                                                <a-icon type="exclamation-circle" theme="filled" style="color: #FFA031"></a-icon>
                                                {{ i18n "pages.xray.generalConfigsDesc" }}
                                            </template>
                                        </a-alert>
                                    </a-row>
                                    <a-list-item>
                                        <a-row style="padding: 20px">
                                            <a-col :lg="24" :xl="12">
                                                <a-list-item-meta title='{{ i18n "pages.xray.FreedomStrategy" }}'
                                                    description='{{ i18n "pages.xray.FreedomStrategyDesc" }}' />
                                            </a-col>
                                            <a-col :lg="24" :xl="12">
                                                <template>
                                                    <a-select v-model="freedomStrategy" :dropdown-class-name="themeSwitcher.currentTheme"
                                                        style="width: 100%">
                                                        <a-select-option v-for="s in OutboundDomainStrategies" :value="s">[[ s ]]</a-select-option>
                                                    </a-select>
                                                </template>
                                            </a-col>
                                        </a-row>
                                    </a-list-item>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.xray.RoutingStrategy" }}'
                                                description='{{ i18n "pages.xray.RoutingStrategyDesc" }}' />
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                                <a-select v-model="routingStrategy" :dropdown-class-name="themeSwitcher.currentTheme"
                                                    style="width: 100%">
                                                    <a-select-option v-for="s in routingDomainStrategies" :value="s">[[ s ]]</a-select-option>
                                                </a-select>
                                        </a-col>
                                    </a-row>
                                    </a-list-item>
                                </a-collapse-panel>
                                <a-collapse-panel header='{{ i18n "pages.xray.logConfigs" }}'>
                                    <a-row :xs="24" :sm="24" :lg="12">
                                        <a-alert type="warning" style="text-align: center;">
                                            <template slot="message">
                                                <a-icon type="exclamation-circle" theme="filled" style="color: #FFA031"></a-icon>
                                                {{ i18n "pages.xray.logConfigsDesc" }}
                                            </template>
                                        </a-alert>
                                    </a-row>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.xray.logLevel" }}'
                                                description='{{ i18n "pages.xray.logLevelDesc" }}' />
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-select v-model="setLogLevel" :dropdown-class-name="themeSwitcher.currentTheme" style="width: 100%">
                                                    <a-select-option v-for="s in logLevel" :value="s">[[ s ]]</a-select-option>
                                                </a-select>
                                            </template>
                                        </a-col>
                                    </a-row>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.xray.accessLog" }}'
                                                description='{{ i18n "pages.xray.accessLogDesc" }}' />
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-select v-model="accessLog" :dropdown-class-name="themeSwitcher.currentTheme" style="width: 100%">
                                                    <a-select-option v-for="s in access" :key="s" :value="s">[[ s ]]</a-select-option>
                                                </a-select>
                                            </template>
                                        </a-col>
                                    </a-row>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.xray.errorLog" }}'
                                                description='{{ i18n "pages.xray.errorLogDesc" }}' />
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-select v-model="errorLog" :dropdown-class-name="themeSwitcher.currentTheme" style="width: 100%">
                                                    <a-select-option v-for="s in error" :key="s" :value="s">[[ s ]]</a-select-option>
                                                </a-select>
                                            </template>
                                        </a-col>
                                    </a-row>
                                    </a-list-item>
                                </a-collapse-panel>
                                <a-collapse-panel header='{{ i18n "pages.xray.blockConfigs"}}'>
                                    <a-row :xs="24" :sm="24" :lg="12">
                                        <a-alert type="warning" style="text-align: center;">
                                            <template slot="message">
                                                <a-icon type="exclamation-circle" theme="filled" style="color: #FFA031"></a-icon>
                                                {{ i18n "pages.xray.blockConfigsDesc" }}
                                            </template>
                                        </a-alert>
                                    </a-row>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.Torrent"}}' desc='{{ i18n "pages.xray.TorrentDesc"}}' v-model="torrentSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.PrivateIp"}}' desc='{{ i18n "pages.xray.PrivateIpDesc"}}' v-model="privateIpSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.Ads"}}' desc='{{ i18n "pages.xray.AdsDesc"}}' v-model="AdsSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.Family"}}' desc='{{ i18n "pages.xray.FamilyDesc"}}' v-model="familyProtectSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.Security"}}' desc='{{ i18n "pages.xray.SecurityDesc"}}' v-model="SecuritySettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.Speedtest"}}' desc='{{ i18n "pages.xray.SpeedtestDesc"}}' v-model="SpeedTestSettings"></setting-list-item>
                                </a-collapse-panel>
                                <a-collapse-panel header='{{ i18n "pages.xray.blockCountryConfigs"}}'>
                                    <a-row :xs="24" :sm="24" :lg="12">
                                        <a-alert type="warning" style="text-align: center;">
                                            <template slot="message">
                                                <a-icon type="exclamation-circle" theme="filled" style="color: #FFA031"></a-icon>
                                                {{ i18n "pages.xray.blockCountryConfigsDesc" }}
                                            </template>
                                        </a-alert>
                                    </a-row>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.IRIp"}}' desc='{{ i18n "pages.xray.IRIpDesc"}}' v-model="IRIpSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.IRDomain"}}' desc='{{ i18n "pages.xray.IRDomainDesc"}}' v-model="IRDomainSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.ChinaIp"}}' desc='{{ i18n "pages.xray.ChinaIpDesc"}}' v-model="ChinaIpSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.ChinaDomain"}}' desc='{{ i18n "pages.xray.ChinaDomainDesc"}}' v-model="ChinaDomainSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.RussiaIp"}}' desc='{{ i18n "pages.xray.RussiaIpDesc"}}' v-model="RussiaIpSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.RussiaDomain"}}' desc='{{ i18n "pages.xray.RussiaDomainDesc"}}' v-model="RussiaDomainSettings"></setting-list-item>
				                    <setting-list-item type="switch" title='{{ i18n "pages.xray.VNIp"}}' desc='{{ i18n "pages.xray.VNIpDesc"}}' v-model="VNIpSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.VNDomain"}}' desc='{{ i18n "pages.xray.VNDomainDesc"}}' v-model="VNDomainSettings"></setting-list-item>
                                </a-collapse-panel>
                                <a-collapse-panel header='{{ i18n "pages.xray.directCountryConfigs"}}'>
                                    <a-row :xs="24" :sm="24" :lg="12">
                                        <a-alert type="warning" style="text-align: center;">
                                            <template slot="message">
                                                <a-icon type="exclamation-circle" theme="filled" style="color: #FFA031"></a-icon>
                                                {{ i18n "pages.xray.directCountryConfigsDesc" }}
                                            </template>
                                        </a-alert>
                                    </a-row>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectIRIp"}}' desc='{{ i18n "pages.xray.DirectIRIpDesc"}}' v-model="IRIpDirectSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectIRDomain"}}' desc='{{ i18n "pages.xray.DirectIRDomainDesc"}}' v-model="IRDomainDirectSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectChinaIp"}}' desc='{{ i18n "pages.xray.DirectChinaIpDesc"}}' v-model="ChinaIpDirectSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectChinaDomain"}}' desc='{{ i18n "pages.xray.DirectChinaDomainDesc"}}' v-model="ChinaDomainDirectSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectRussiaIp"}}' desc='{{ i18n "pages.xray.DirectRussiaIpDesc"}}' v-model="RussiaIpDirectSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectRussiaDomain"}}' desc='{{ i18n "pages.xray.DirectRussiaDomainDesc"}}' v-model="RussiaDomainDirectSettings"></setting-list-item>
				                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectVNIp"}}' desc='{{ i18n "pages.xray.DirectVNIpDesc"}}' v-model="VNIpDirectSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.DirectVNDomain"}}' desc='{{ i18n "pages.xray.DirectVNDomainDesc"}}' v-model="VNDomainDirectSettings"></setting-list-item>									
                                </a-collapse-panel>
                                <a-collapse-panel header='{{ i18n "pages.xray.ipv4Configs"}}'>
                                    <a-row :xs="24" :sm="24" :lg="12">
                                        <a-alert type="warning" style="text-align: center;">
                                            <template slot="message">
                                                <a-icon type="exclamation-circle" theme="filled" style="color: #FFA031"></a-icon>
                                                {{ i18n "pages.xray.ipv4ConfigsDesc" }}
                                            </template>
                                        </a-alert>
                                    </a-row>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.GoogleIPv4"}}' desc='{{ i18n "pages.xray.GoogleIPv4Desc"}}' v-model="GoogleIPv4Settings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.NetflixIPv4"}}' desc='{{ i18n "pages.xray.NetflixIPv4Desc"}}' v-model="NetflixIPv4Settings"></setting-list-item>
                                </a-collapse-panel>
                                <a-collapse-panel header='{{ i18n "pages.xray.warpConfigs"}}'>
                                    <a-row :xs="24" :sm="24" :lg="12">
                                        <a-alert type="warning" style="text-align: center;">
                                            <template slot="message">
                                                <a-icon type="exclamation-circle" theme="filled" style="color: #FFA031"></a-icon>
                                                {{ i18n "pages.xray.warpConfigsDesc" }}
                                            </template>
                                        </a-alert>
                                    </a-row>
                                <template v-if="WarpExist">
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.GoogleWARP"}}' desc='{{ i18n "pages.xray.GoogleWARPDesc"}}' v-model="GoogleWARPSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.OpenAIWARP"}}' desc='{{ i18n "pages.xray.OpenAIWARPDesc"}}' v-model="OpenAIWARPSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.NetflixWARP"}}' desc='{{ i18n "pages.xray.NetflixWARPDesc"}}' v-model="NetflixWARPSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.SpotifyWARP"}}' desc='{{ i18n "pages.xray.SpotifyWARPDesc"}}' v-model="SpotifyWARPSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.MetaWARP"}}' desc='{{ i18n "pages.xray.MetaWARPDesc"}}' v-model="MetaWARPSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.AppleWARP"}}' desc='{{ i18n "pages.xray.AppleWARPDesc"}}' v-model="AppleWARPSettings"></setting-list-item>
                                    <setting-list-item type="switch" title='{{ i18n "pages.xray.RedditWARP"}}' desc='{{ i18n "pages.xray.RedditWARPDesc"}}' v-model="RedditWARPSettings"></setting-list-item>
                                </template>
                                <a-button v-else type="primary" icon="cloud" style="margin: 15px 20px;" @click="showWarp()">WARP</a-button>
                                </a-collapse-panel>
                                <a-collapse-panel header='{{ i18n "pages.settings.resetDefaultConfig"}}'>
                                    <a-space direction="horizontal" style="padding: 0 20px">
                                        <a-button type="danger" @click="resetXrayConfigToDefault">{{ i18n "pages.settings.resetDefaultConfig" }}</a-button>
                                    </a-space>
                                </a-collapse-panel>
                            </a-collapse>
                        </a-tab-pane>
                        <a-tab-pane key="tpl-routing" tab='{{ i18n "pages.xray.Routings"}}' style="padding-top: 20px;">
                            <a-button type="primary" icon="plus" @click="addRule">{{ i18n "pages.xray.rules.add" }}</a-button>
                            <a-table-sortable :columns="isMobile ? rulesMobileColumns : rulesColumns" bordered
                                :row-key="r => r.key"
                                :data-source="routingRuleData"
                                :scroll="isMobile ? {} : { x: 1000 }"
                                :pagination="false"
                                :indent-size="0"
                                :style="isMobile ? 'padding: 5px 0' : 'margin-top: 10px;'"
                                v-on:onSort="replaceRule">
                                <template slot="action" slot-scope="text, rule, index">
                                    <table-sort-trigger :item-index="index"></table-sort-trigger>
                                    <span class="ant-table-row-index">
                                        [[ index+1 ]]
                                    </span>
                                    <a-dropdown :trigger="['click']">
                                        <a-icon @click="e => e.preventDefault()" type="more" style="font-size: 16px; text-decoration: bold;"></a-icon>
                                        <a-menu slot="overlay" :theme="themeSwitcher.currentTheme">
                                            <a-menu-item v-if="index>0" @click="replaceRule(index,0)">
                                                <a-icon type="vertical-align-top"></a-icon>
                                                {{ i18n "pages.xray.rules.first"}}
                                            </a-menu-item>
                                            <a-menu-item v-if="index>0" @click="replaceRule(index,index-1)">
                                                <a-icon type="arrow-up"></a-icon>
                                                {{ i18n "pages.xray.rules.up"}}
                                            </a-menu-item>
                                            <a-menu-item v-if="index<routingRuleData.length-1" @click="replaceRule(index,index+1)">
                                                <a-icon type="arrow-down"></a-icon>
                                                {{ i18n "pages.xray.rules.down"}}
                                            </a-menu-item>
                                            <a-menu-item v-if="index<routingRuleData.length-1" @click="replaceRule(index,routingRuleData.length-1)">
                                                <a-icon type="vertical-align-bottom"></a-icon>
                                                {{ i18n "pages.xray.rules.last"}}
                                            </a-menu-item>
                                            <a-menu-item @click="editRule(index)">
                                                <a-icon type="edit"></a-icon>
                                                {{ i18n "edit" }}
                                            </a-menu-item>
                                            <a-menu-item @click="deleteRule(index)">
                                                <span style="color: #FF4D4F">
                                                    <a-icon type="delete"></a-icon> {{ i18n "delete"}}
                                                </span>
                                            </a-menu-item>
                                        </a-menu>
                                    </a-dropdown>
                                </template>
                                <template slot="inbound" slot-scope="text, rule, index">
                                    <a-popover :overlay-class-name="themeSwitcher.currentTheme">
                                        <template slot="content">
                                            <p v-if="rule.inboundTag">Inbound Tag: [[ rule.inboundTag ]]</p>
                                            <p v-if="rule.user">User email: [[ rule.user ]]</p>
                                        </template>
                                        [[ [rule.inboundTag,rule.user].join('\n') ]]
                                    </a-popover>
                                </template>
                                <template slot="outbound" slot-scope="text, rule, index">
                                    <a-popover :overlay-class-name="themeSwitcher.currentTheme">
                                        <template slot="content">
                                            <p v-if="rule.outboundTag">Outbound Tag: [[ rule.outboundTag ]]</p>
                                        </template>
                                        [[ rule.outboundTag ]]
                                    </a-popover>
                                </template>
                                <template slot="balancer" slot-scope="text, rule, index">
                                    <a-popover :overlay-class-name="themeSwitcher.currentTheme">
                                        <template slot="content">
                                            <p v-if="rule.balancerTag">Balancer Tag: [[ rule.balancerTag ]]</p>
                                        </template>
                                        [[ rule.balancerTag ]]
                                    </a-popover>
                                </template>
                                <template slot="info" slot-scope="text, rule, index">
                                    <a-popover placement="bottomRight"
                                        v-if="(rule.source+rule.sourcePort+rule.network+rule.protocol+rule.attrs+rule.ip+rule.domain+rule.port).length>0"
                                        :overlay-class-name="themeSwitcher.currentTheme" trigger="click">
                                        <template slot="content">
                                            <table cellpadding="2" style="max-width: 300px;">
                                                <tr v-if="rule.source">
                                                    <td>Source</td>
                                                    <td><a-tag color="blue" v-for="r in rule.source.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.sourcePort">
                                                    <td>Source Port</td>
                                                    <td><a-tag color="green" v-for="r in rule.sourcePort.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.network">
                                                    <td>Network</td>
                                                    <td><a-tag color="blue" v-for="r in rule.network.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.protocol">
                                                    <td>Protocol</td>
                                                    <td><a-tag color="green" v-for="r in rule.protocol.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.attrs">
                                                    <td>Attrs</td>
                                                    <td><a-tag color="blue" v-for="r in rule.attrs.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.ip">
                                                    <td>IP</td>
                                                    <td><a-tag color="green" v-for="r in rule.ip.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.domain">
                                                    <td>Domain</td>
                                                    <td><a-tag color="blue" v-for="r in rule.domain.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.port">
                                                    <td>Port</td>
                                                    <td><a-tag color="green" v-for="r in rule.port.split(',')">[[ r ]]</a-tag></td>
                                                </tr>
                                                <tr v-if="rule.balancerTag">
                                                    <td>Balancer Tag</td>
                                                    <td><a-tag color="blue">[[ rule.balancerTag ]]</a-tag></td>
                                                </tr>
                                            </table>
                                        </template>
                                        <a-button shape="round" size="small" style="font-size: 14px; padding: 0 10px;">
                                            <a-icon type="info"></a-icon>
                                        </a-button>
                                    </a-popover>
                                </template>
                            </a-table-sortable>
                        </a-tab-pane>
                        <a-tab-pane key="tpl-outbound" tab='{{ i18n "pages.xray.Outbounds"}}' style="padding-top: 20px;" force-render="true">
                            <a-row>
                                <a-col :xs="12" :sm="12" :lg="12">
                                    <a-button type="primary" icon="plus" @click="addOutbound()" style="margin-bottom: 10px;">{{ i18n
                                        "pages.xray.outbound.addOutbound" }}</a-button>
                                    <a-button type="primary" icon="cloud" @click="showWarp()" style="margin-bottom: 10px;">WARP</a-button>
                                </a-col>
                                <a-col :xs="12" :sm="12" :lg="12" style="text-align: right;">
                                    <a-icon type="sync" :spin="refreshing" @click="refreshOutboundTraffic()" style="margin: 0 5px;"></a-icon>
                                    <a-popconfirm placement="topRight" @confirm="resetOutboundTraffic(-1)"
                                        title='{{ i18n "pages.inbounds.resetTrafficContent"}}'
                                        :overlay-class-name="themeSwitcher.currentTheme"
                                        ok-text='{{ i18n "reset"}}'
                                        cancel-text='{{ i18n "cancel"}}'>
                                        <a-icon slot="icon" type="question-circle-o" :style="themeSwitcher.isDarkTheme ? 'color: #008771' : 'color: #008771'"></a-icon>
                                        <a-icon type="retweet" style="cursor: pointer;"></a-icon>
                                    </a-popconfirm>
                                </a-col>
                            </a-row>
                            <a-table :columns="outboundColumns" bordered
                            :row-key="r => r.key"
                            :data-source="outboundData"
                            :scroll="isMobile ? {} : { x: 200 }"
                            :pagination="false"
                            :indent-size="0"
                            :style="isMobile ? 'padding: 5px 5px' : 'margin-right: 1px;'">
                                <template slot="action" slot-scope="text, outbound, index">
                                    [[ index+1 ]]
                                    <a-dropdown :trigger="['click']">
                                        <a-icon @click="e => e.preventDefault()" type="more" style="font-size: 16px; text-decoration: bold;"></a-icon>
                                        <a-menu slot="overlay" :theme="themeSwitcher.currentTheme">
                                            <a-menu-item v-if="index>0" @click="setFirstOutbound(index)">
                                                <a-icon type="vertical-align-top"></a-icon>
                                                {{ i18n "pages.xray.rules.first"}}
                                            </a-menu-item>
                                            <a-menu-item @click="editOutbound(index)">
                                                <a-icon type="edit"></a-icon>
                                                {{ i18n "edit" }}
                                            </a-menu-item>
                                            <a-menu-item @click="resetOutboundTraffic(index)">
                                                <span>
                                                    <a-icon type="retweet"></a-icon> {{ i18n "pages.inbounds.resetTraffic"}}
                                                </span>
                                            </a-menu-item>
                                            <a-menu-item @click="deleteOutbound(index)">
                                                <span style="color: #FF4D4F">
                                                    <a-icon type="delete"></a-icon> {{ i18n "delete"}}
                                                </span>
                                            </a-menu-item>
                                        </a-menu>
                                    </a-dropdown>
                                </template>
                                <template slot="address" slot-scope="text, outbound, index">
                                    <p style="margin: 0 5px;" v-for="addr in findOutboundAddress(outbound)">[[ addr ]]</p>
                                </template>
                                <template slot="protocol" slot-scope="text, outbound, index">
                                    <a-tag style="margin:0;" color="purple">[[ outbound.protocol ]]</a-tag>
                                    <template v-if="[Protocols.VMess, Protocols.VLESS, Protocols.Trojan, Protocols.Shadowsocks].includes(outbound.protocol)">
                                        <a-tag style="margin:0;" color="blue">[[ outbound.streamSettings.network ]]</a-tag>
                                        <a-tag style="margin:0;" v-if="outbound.streamSettings.security=='tls'" color="green">tls</a-tag>
                                        <a-tag style="margin:0;" v-if="outbound.streamSettings.security=='reality'" color="green">reality</a-tag>
                                    </template>
                                </template>
                                <template slot="traffic" slot-scope="text, outbound, index">
                                    <a-tag color="green">[[ findOutboundTraffic(outbound) ]]</a-tag>
                                </template>
                            </a-table>
                        </a-tab-pane>
                        <a-tab-pane key="tpl-reverse" tab='{{ i18n "pages.xray.outbound.reverse"}}' style="padding-top: 20px;" force-render="true">
                            <a-button type="primary" icon="plus" @click="addReverse()" style="margin-bottom: 10px;">{{ i18n "pages.xray.outbound.addReverse" }}</a-button>
                            <a-table :columns="reverseColumns" bordered v-if="reverseData.length>0"
                            :row-key="r => r.key"
                            :data-source="reverseData"
                            :scroll="isMobile ? {} : { x: 200 }"
                            :pagination="false"
                            :indent-size="0"
                            :style="isMobile ? 'padding: 5px 0' : 'margin-left: 1px;'">
                                <template slot="action" slot-scope="text, reverse, index">
                                    [[ index+1 ]]
                                    <a-dropdown :trigger="['click']">
                                        <a-icon @click="e => e.preventDefault()" type="more" style="font-size: 16px; text-decoration: bold;"></a-icon>
                                        <a-menu slot="overlay" :theme="themeSwitcher.currentTheme">
                                            <a-menu-item @click="editReverse(index)">
                                                <a-icon type="edit"></a-icon>
                                                {{ i18n "edit" }}
                                            </a-menu-item>
                                            <a-menu-item @click="deleteReverse(index)">
                                                <span style="color: #FF4D4F">
                                                    <a-icon type="delete"></a-icon> {{ i18n "delete"}}
                                                </span>
                                            </a-menu-item>
                                        </a-menu>
                                    </a-dropdown>
                                </template>
                            </a-table>
                        </a-tab-pane>
                        <a-tab-pane key="tpl-balancer" tab='{{ i18n "pages.xray.Balancers"}}' style="padding-top: 20px;" force-render="true">
                            <a-button type="primary" icon="plus" @click="addBalancer()" style="margin-bottom: 10px;">{{ i18n "pages.xray.balancer.addBalancer"}}</a-button>
                            <a-table :columns="balancerColumns" bordered v-if="balancersData.length>0"
                            :row-key="r => r.key"
                            :data-source="balancersData"
                            :scroll="isMobile ? {} : { x: 200 }"
                            :pagination="false"
                            :indent-size="0"
                            :style="isMobile ? 'padding: 5px 0' : 'margin-left: 1px;'">
                                <template slot="action" slot-scope="text, balancer, index">
                                    [[ index+1 ]]
                                    <a-dropdown :trigger="['click']">
                                        <a-icon @click="e => e.preventDefault()" type="more" style="font-size: 16px; text-decoration: bold;"></a-icon>
                                        <a-menu slot="overlay" :theme="themeSwitcher.currentTheme">
                                            <a-menu-item @click="editBalancer(index)">
                                                <a-icon type="edit"></a-icon>
                                                {{ i18n "edit" }}
                                            </a-menu-item>
                                            <a-menu-item @click="deleteBalancer(index)">
                                                <span style="color: #FF4D4F">
                                                    <a-icon type="delete"></a-icon> {{ i18n "delete"}}
                                                </span>
                                            </a-menu-item>
                                        </a-menu>
                                    </a-dropdown>
                                </template>
                                <template slot="strategy" slot-scope="text, balancer, index">
                                    <a-tag style="margin:0;" v-if="balancer.strategy=='random'" color="purple">Random</a-tag>
                                    <a-tag style="margin:0;" v-if="balancer.strategy=='roundRobin'" color="green">Round Robin</a-tag>
                                    <a-tag style="margin:0;" v-if="balancer.strategy=='leastload'" color="green">Least Load</a-tag>
                                    <a-tag style="margin:0;" v-if="balancer.strategy=='leastping'" color="green">Least Ping</a-tag>
                                </template>
                                <template slot="selector" slot-scope="text, balancer, index">
                                    <a-tag class="info-large-tag" style="margin:1;" v-for="sel in balancer.selector">[[ sel ]]</a-tag>
                                </template>
                            </a-table>
                            <a-radio-group
                                v-model="obsSettings"
                                v-if="observatoryEnable || burstObservatoryEnable"
                                @change="changeObsCode"
                                button-style="solid"
                                style="margin: 10px 0;"
                                :size="isMobile ? 'small' : ''">
                                <a-radio-button value="observatory" v-if="observatoryEnable">Observatory</a-radio-button>
                                <a-radio-button value="burstObservatory" v-if="burstObservatoryEnable">Burst Observatory</a-radio-button>
                            </a-radio-group>
                            <textarea style="position:absolute; left: -800px;" id="obsSetting"></textarea>
                        </a-tab-pane>
                        <a-tab-pane key="tpl-dns" tab='DNS' style="padding-top: 20px;" force-render="true">
                            <setting-list-item type="switch" title='{{ i18n "pages.xray.dns.enable" }}' desc='{{ i18n "pages.xray.dns.enableDesc" }}' v-model="enableDNS"></setting-list-item>
                            <template v-if="enableDNS">
                                <setting-list-item type="text" title='{{ i18n "pages.xray.dns.tag" }}' desc='{{ i18n "pages.xray.dns.tagDesc" }}' v-model="dnsTag"></setting-list-item>
                                <a-list-item>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.xray.dns.strategy" }}' description='{{ i18n "pages.xray.dns.strategyDesc" }}' />
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <a-select
                                                v-model="dnsStrategy"
                                                style="width: 100%"
                                                :dropdown-class-name="themeSwitcher.currentTheme">
                                                <a-select-option :value="l" :label="l" v-for="l in ['UseIP', 'UseIPv4', 'UseIPv6']">
                                                    [[ l ]]
                                                </a-select-option>
                                            </a-select>
                                        </a-col>
                                    </a-row>
                                </a-list-item>
                                <a-divider>DNS</a-divider>
                                <a-button type="primary" icon="plus" @click="addDNSServer()" style="margin-bottom: 10px;">{{ i18n "pages.xray.dns.add" }}</a-button>
                                <a-table :columns="dnsColumns" bordered v-if="dnsServers.length>0"
                                :row-key="r => r.key"
                                :data-source="dnsServers"
                                :scroll="isMobile ? {} : { x: 200 }"
                                :pagination="false"
                                :indent-size="0"
                                :style="isMobile ? 'padding: 5px 0' : 'margin-left: 1px;'">
                                    <template slot="action" slot-scope="text,dns,index">
                                        [[ index+1 ]]
                                        <a-dropdown :trigger="['click']">
                                            <a-icon @click="e => e.preventDefault()" type="more" style="font-size: 16px; text-decoration: bold;"></a-icon>
                                            <a-menu slot="overlay" :theme="themeSwitcher.currentTheme">
                                                <a-menu-item @click="editDNSServer(index)">
                                                    <a-icon type="edit"></a-icon>
                                                    {{ i18n "edit" }}
                                                </a-menu-item>
                                                <a-menu-item @click="deleteDNSServer(index)">
                                                    <span style="color: #FF4D4F">
                                                        <a-icon type="delete"></a-icon> {{ i18n "delete"}}
                                                    </span>
                                                </a-menu-item>
                                            </a-menu>
                                        </a-dropdown>
                                    </template>
                                    <template slot="address" slot-scope="dns,index">
                                        <span v-if="typeof dns == 'object'">[[ dns.address ]]</span>
                                        <span v-else>[[ dns ]]</span>
                                    </template>
                                    <template slot="domain" slot-scope="dns,index">
                                        <span v-if="typeof dns == 'object'">[[ dns.domains.join(",") ]]</span>
                                    </template>
                                </a-table>
                                <a-divider>Fake DNS</a-divider>
                                <a-button type="primary" icon="plus" @click="addFakedns()" style="margin-bottom: 10px;">{{ i18n "pages.xray.fakedns.add" }}</a-button>
                                <a-table :columns="fakednsColumns" bordered v-if="fakeDns && fakeDns.length>0" :row-key="r => r.key"
                                    :data-source="fakeDns" :scroll="isMobile ? {} : { x: 200 }" :pagination="false" :indent-size="0"
                                    :style="isMobile ? 'padding: 5px 0' : 'margin-left: 1px;'">
                                    <template slot="action" slot-scope="text,fakedns,index">
                                        [[ index+1 ]]
                                        <a-dropdown :trigger="['click']">
                                            <a-icon @click="e => e.preventDefault()" type="more"
                                                style="font-size: 16px; text-decoration: bold;"></a-icon>
                                            <a-menu slot="overlay" :theme="themeSwitcher.currentTheme">
                                                <a-menu-item @click="editFakedns(index)">
                                                    <a-icon type="edit"></a-icon>
                                                    {{ i18n "edit" }}
                                                </a-menu-item>
                                                <a-menu-item @click="deleteFakedns(index)">
                                                    <span style="color: #FF4D4F">
                                                        <a-icon type="delete"></a-icon> {{ i18n "delete"}}
                                                    </span>
                                                </a-menu-item>
                                            </a-menu>
                                        </a-dropdown>
                                    </template>
                                </a-table>
                            </template>
                        </a-tab-pane>
                        <a-tab-pane key="tpl-advanced" tab='{{ i18n "pages.xray.advancedTemplate"}}' style="padding-top: 20px;" force-render="true">
                            <a-list-item-meta title='{{ i18n "pages.xray.Template"}}' description='{{ i18n "pages.xray.TemplateDesc"}}'></a-list-item-meta>
                            <a-radio-group v-model="advSettings" @change="changeCode" button-style="solid" style="margin: 10px 0;" :size="isMobile ? 'small' : ''">
                                <a-radio-button value="xraySetting">{{ i18n "pages.xray.completeTemplate"}}</a-radio-button>
                                <a-radio-button value="inboundSettings">{{ i18n "pages.xray.Inbounds" }}</a-radio-button>
                                <a-radio-button value="outboundSettings">{{ i18n "pages.xray.Outbounds" }}</a-radio-button>
                                <a-radio-button value="routingRuleSettings">{{ i18n "pages.xray.Routings" }}</a-radio-button>
                            </a-radio-group>
                            <textarea style="position:absolute; left: -800px;" id="xraySetting"></textarea>
                        </a-tab-pane>
                    </a-tabs>
                </a-space>
            </a-spin>
        </a-layout-content>
    </a-layout>
</a-layout>
{{template "js" .}}
{{template "component/themeSwitcher" .}}
{{template "component/sortableTable" .}}
{{template "component/setting"}}
{{template "ruleModal"}}
{{template "outModal"}}
{{template "reverseModal"}}
{{template "balancerModal"}}
{{template "dnsModal"}}
{{template "fakednsModal"}}
{{template "warpModal"}}
<script>
        const rulesColumns = [
        { title: "#", align: 'center', width: 15, scopedSlots: { customRender: 'action' } },
        { title: '{{ i18n "pages.xray.rules.source"}}', children: [
            { title: 'IP', dataIndex: "source", align: 'center', width: 20, ellipsis: true },
            { title: 'Port', dataIndex: 'sourcePort', align: 'center', width: 10, ellipsis: true } ]},
        { title: '{{ i18n "pages.inbounds.network"}}', children: [
            { title: 'L4', dataIndex: 'network', align: 'center', width: 10 },
            { title: 'Protocol', dataIndex: 'protocol', align: 'center', width: 10, ellipsis: true },
            { title: 'Attrs', dataIndex: 'attrs', align: 'center', width: 20, ellipsis: true } ]}, 
        { title: '{{ i18n "pages.xray.rules.dest"}}', children: [
            { title: 'IP', dataIndex: 'ip', align: 'center', width: 20, ellipsis: true },
            { title: 'Domain', dataIndex: 'domain', align: 'center', width: 20, ellipsis: true },
            { title: 'Port', dataIndex: 'port', align: 'center', width: 10, ellipsis: true }]},
        { title: '{{ i18n "pages.xray.rules.inbound"}}', children: [
            { title: 'Inbound Tag', dataIndex: 'inboundTag', align: 'center', width: 15, ellipsis: true },
            { title: 'Client Email', dataIndex: 'user', align: 'center', width: 20, ellipsis: true }]},
        { title: '{{ i18n "pages.xray.rules.outbound"}}', dataIndex: 'outboundTag', align: 'center', width: 15 },
        { title: '{{ i18n "pages.xray.rules.balancer"}}', dataIndex: 'balancerTag', align: 'center', width: 15 },
    ];

    const rulesMobileColumns = [
        { title: "#", align: 'center', width: 20, scopedSlots: { customRender: 'action' } },
        { title: '{{ i18n "pages.xray.rules.inbound"}}', align: 'center', width: 50, ellipsis: true, scopedSlots: { customRender: 'inbound' } },
        { title: '{{ i18n "pages.xray.rules.outbound"}}', align: 'center', width: 50, ellipsis: true, scopedSlots: { customRender: 'outbound' } },
        { title: '{{ i18n "pages.xray.rules.info"}}', align: 'center', width: 50, ellipsis: true, scopedSlots: { customRender: 'info' } },
    ];

    const outboundColumns = [
        { title: "#", align: 'center', width: 20, scopedSlots: { customRender: 'action' } },
        { title: '{{ i18n "pages.xray.outbound.tag"}}', dataIndex: 'tag', align: 'center', width: 50 },
        { title: '{{ i18n "protocol"}}', align: 'center', width: 50, scopedSlots: { customRender: 'protocol' }  },
        { title: '{{ i18n "pages.xray.outbound.address"}}', align: 'center', width: 50, scopedSlots: { customRender: 'address' } },
        { title: '{{ i18n "pages.inbounds.traffic" }}', align: 'center', width: 50, scopedSlots: { customRender: 'traffic' } },
    ];

    const reverseColumns = [
        { title: "#", align: 'center', width: 20, scopedSlots: { customRender: 'action' } },
        { title: '{{ i18n "pages.xray.outbound.type"}}', dataIndex: 'type', align: 'center', width: 50 },
        { title: '{{ i18n "pages.xray.outbound.tag"}}', dataIndex: 'tag', align: 'center', width: 50 },
        { title: '{{ i18n "pages.xray.outbound.domain"}}', dataIndex: 'domain', align: 'center', width: 50 },
    ];

    const balancerColumns = [
        { title: "#", align: 'center', width: 20, scopedSlots: { customRender: 'action' } },
        { title: '{{ i18n "pages.xray.balancer.tag"}}', dataIndex: 'tag', align: 'center', width: 50 },
        { title: '{{ i18n "pages.xray.balancer.balancerStrategy"}}', align: 'center', width: 50, scopedSlots: { customRender: 'strategy' }},
        { title: '{{ i18n "pages.xray.balancer.balancerSelectors"}}', align: 'center', width: 100, scopedSlots: { customRender: 'selector' }},
    ];

    const dnsColumns = [
        { title: "#", align: 'center', width: 20, scopedSlots: { customRender: 'action' } },
        { title: '{{ i18n "pages.xray.outbound.address"}}', align: 'center', width: 50, scopedSlots: { customRender: 'address' } },
        { title: '{{ i18n "pages.xray.dns.domains"}}', align: 'center', width: 50, scopedSlots: { customRender: 'domain' } },
    ];

    const fakednsColumns = [
        { title: "#", align: 'center', width: 20, scopedSlots: { customRender: 'action' } },
        { title: '{{ i18n "pages.xray.fakedns.ipPool"}}', dataIndex: 'ipPool', align: 'center', width: 50 },
        { title: '{{ i18n "pages.xray.fakedns.poolSize"}}', dataIndex: 'poolSize', align: 'center', width: 50 },
    ];

    const app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            siderDrawer,
            themeSwitcher,
            isDarkTheme: themeSwitcher.isDarkTheme,
            spinning: false,
            oldXraySetting: '',
            xraySetting: '',
            inboundTags: [],
            outboundsTraffic: [],
            saveBtnDisable: true,
            refreshing: false,
            restartResult: '',
            showAlert: false,
            isMobile: window.innerWidth <= 768,
            advSettings: 'xraySetting',
            obsSettings: '',
            cm: null,
            cmOptions: {
                lineNumbers: true,
                mode: "application/json",
                lint: true,
                styleActiveLine: true,
                matchBrackets: true,
                theme: "xq",
                autoCloseTags: true,
                lineWrapping: true,
                indentUnit: 2,
                indentWithTabs: true,
                smartIndent: true,
                tabSize: 2,
                lineWiseCopyCut: false,
                foldGutter: true,
                gutters: [
                    "CodeMirror-lint-markers",
                    "CodeMirror-linenumbers",
                    "CodeMirror-foldgutter",
                ],
            },
            ipv4Settings: {
                tag: "IPv4",
                protocol: "freedom",
                settings: {
                    domainStrategy: "UseIPv4"
                }
            },
            directSettings: {
                tag: "direct",
                protocol: "freedom"
            },
            routingDomainStrategies: ["AsIs", "IPIfNonMatch", "IPOnDemand"],
            logLevel: ["none" , "debug" , "info" , "warning", "error"],
            access: [],
            error: [],
            settingsData: {
                protocols: {
                    bittorrent: ["bittorrent"],
                },
                ips: {
                    local: ["geoip:private"],
                    cn: ["geoip:cn"],
                    ir: ["ext:geoip_IR.dat:ir"],
                    ru: ["geoip:ru"],
                    vn: ["ext:geoip_VN.dat:vn"],
                },
                domains: {
                    ads: [
                        "geosite:category-ads-all",
                        "ext:geosite_IR.dat:category-ads-all"
                    ],
                    security: [
                        "ext:geosite_IR.dat:malware",
                        "ext:geosite_IR.dat:phishing",
                        "ext:geosite_IR.dat:cryptominers"
                    ],
                    speedtest: ["geosite:speedtest"],
                    openai: ["geosite:openai"],
                    google: ["geosite:google"],
                    spotify: ["geosite:spotify"],
                    netflix: ["geosite:netflix"],
                    meta: ["geosite:meta"],
                    apple: ["geosite:apple"],
                    reddit: ["geosite:reddit"],
                    cn: [
                        "geosite:cn",
                        "regexp:.*\\.cn$"
                    ],
                    ru: [
                        "geosite:category-gov-ru",
                        "regexp:.*\\.ru$"
                    ],
                    ir: [
                        "regexp:.*\\.ir$",
                        "regexp:.*\\.xn--mgba3a4f16a$",  // .
                        "ext:geosite_IR.dat:ir"
                    ],
                    vn: [
                        "regexp:.*\\.vn$",
                        "ext:geosite_VN.dat:vn",
                        "ext:geosite_VN.dat:ads"
                    ]
                },
                familyProtectDNS: {
                    "servers": [
                        "1.1.1.3",  // https://developers.cloudflare.com/1.1.1.1/setup/
                        "1.0.0.3",
                        "2606:4700:4700::1113",
                        "2606:4700:4700::1003"
                    ],
                    "queryStrategy": "UseIP"
                },
            },
            defaultObservatory: {
                subjectSelector: [],
                probeURL: "http://www.google.com/gen_204",
                probeInterval: "10m",
                enableConcurrency: true
            },
            defaultBurstObservatory: {
                subjectSelector: [],
                pingConfig: {
                    destination: "http://www.google.com/gen_204",
                    interval: "30m",
                    connectivity: "http://connectivitycheck.platform.hicloud.com/generate_204",
                    timeout: "10s",
                    sampling: 2
                }
            }
        },
        methods: {
            loading(spinning = true) {
                this.spinning = spinning;
            },
            async getOutboundsTraffic() {
                const msg = await HttpUtil.get("/panel/xray/getOutboundsTraffic");
                if (msg.success) {
                    this.outboundsTraffic = msg.obj;
                }
            },
            async getXraySetting() {
                this.loading(true);
                const msg = await HttpUtil.post("/panel/xray/");
                this.loading(false);
                if (msg.success) {
                    result = JSON.parse(msg.obj);
                    xs = JSON.stringify(result.xraySetting, null, 2);
                    this.oldXraySetting = xs;
                    this.xraySetting = xs;
                    this.inboundTags = result.inboundTags;
                    this.saveBtnDisable = true;
                }
            },
            async updateXraySetting() {
                this.loading(true);
                const msg = await HttpUtil.post("/panel/xray/update", {xraySetting : this.xraySetting});
                this.loading(false);
                if (msg.success) {
                    await this.getXraySetting();
                }
            },
            async restartXray() {
                this.loading(true);
                const msg = await HttpUtil.post("server/restartXrayService");
                this.loading(false);
                if (msg.success) {
                    await PromiseUtil.sleep(500);
                    await this.getXrayResult();
                }
                this.loading(false);
            },
            async getXrayResult() {
                const msg = await HttpUtil.get("/panel/xray/getXrayResult");
                if (msg.success) {
                    this.restartResult=msg.obj;
                    if(msg.obj.length > 1) Vue.prototype.$message.error(msg.obj);
                }
            },
            async fetchUserSecret() {
                this.loading(true);
                const userMessage = await HttpUtil.post("/panel/setting/getUserSecret", this.user);
                if (userMessage.success) {
                    this.user = userMessage.obj;
                }
                this.loading(false);
            },
            async updateSecret() {
                this.loading(true);
                const msg = await HttpUtil.post("/panel/setting/updateUserSecret", this.user);
                if (msg.success) {
                    this.user = msg.obj;
                    window.location.replace(basePath + "logout");
                }
                this.loading(false);
                await this.updateXraySetting();
            },
            generateRandomString(length) {
                var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";
                let randomString = "";
                for (let i = 0; i < length; i++) {
                    randomString += chars[Math.floor(Math.random() * chars.length)];
                }
                return randomString;
            },
            async getNewSecret() {
                this.loading(true);
                await PromiseUtil.sleep(600);
                const newSecret = this.generateRandomString(64);
                this.user.loginSecret = newSecret;
                document.getElementById("token").textContent = newSecret;
                this.loading(false);
            },
            async toggleToken(value) {
                if (value) {
                    await this.getNewSecret();
                } else {
                    this.user.loginSecret = "";
                }
            },
            async resetXrayConfigToDefault() {
                this.loading(true);
                const msg = await HttpUtil.get("/panel/setting/getDefaultJsonConfig");
                this.loading(false);
                if (msg.success) {
                    this.templateSettings = JSON.parse(JSON.stringify(msg.obj, null, 2));
                    this.saveBtnDisable = true;
                }
            },
            changePage(pageKey) {
                if(pageKey == 'tpl-advanced') this.changeCode();
                if(pageKey == 'tpl-balancer') this.changeObsCode();
            },
            syncRulesWithOutbound(tag, setting) {
                const newTemplateSettings = this.templateSettings;
                const haveRules = newTemplateSettings.routing.rules.some((r) => r?.outboundTag === tag);
                const outboundIndex = newTemplateSettings.outbounds.findIndex((o) => o.tag === tag);
                if (!haveRules && outboundIndex > 0) {
                    newTemplateSettings.outbounds.splice(outboundIndex);
                }
                if (haveRules && outboundIndex < 0) {
                    newTemplateSettings.outbounds.push(setting);
                }
                this.templateSettings = newTemplateSettings;
            },
            templateRuleGetter(routeSettings) {
                const { property, outboundTag } = routeSettings;
                let result = [];
                if (this.templateSettings != null) {
                    this.templateSettings.routing.rules.forEach(
                        (routingRule) => {
                            if (
                                routingRule.hasOwnProperty(property) &&
                                routingRule.hasOwnProperty("outboundTag") &&
                                routingRule.outboundTag === outboundTag
                            ) {
                                result.push(...routingRule[property]);
                            }
                        }
                    );
                }
                return result;
            },
            templateRuleSetter(routeSettings) {
                const { data, property, outboundTag } = routeSettings;
                const oldTemplateSettings = this.templateSettings;
                const newTemplateSettings = oldTemplateSettings;
                currentProperty = this.templateRuleGetter({ outboundTag, property })
                if (currentProperty.length == 0) {
                    const propertyRule = {
                        type: "field",
                        outboundTag,
                        [property]: data
                    };
                    newTemplateSettings.routing.rules.push(propertyRule);
                }
                else {
                    const newRules = [];
                    insertedOnce = false;
                    newTemplateSettings.routing.rules.forEach(
                        (routingRule) => {
                            if (
                                routingRule.hasOwnProperty(property) &&
                                routingRule.hasOwnProperty("outboundTag") &&
                                routingRule.outboundTag === outboundTag
                            ) {
                                if (!insertedOnce && data.length > 0) {
                                    insertedOnce = true;
                                    routingRule[property] = data;
                                    newRules.push(routingRule);
                                }
                            }
                            else {
                                newRules.push(routingRule);
                            }
                        }
                    );
                    newTemplateSettings.routing.rules = newRules;
                }
                this.templateSettings = newTemplateSettings;
            },
            changeCode() {
                if(this.cm != null) {
                    this.cm.toTextArea();
                }
                textAreaObj = document.getElementById('xraySetting');
                textAreaObj.value = this[this.advSettings];
                this.cm = CodeMirror.fromTextArea(textAreaObj, this.cmOptions);
                this.cm.on('change',editor => {
                    value = editor.getValue();
                    if (this.isJsonString(value)) {
                        this[this.advSettings] = value;
                    }
                });
            },
            changeObsCode() {
                if (this.obsSettings == ''){
                    return
                }
                if(this.cm != null) {
                    this.cm.toTextArea();
                }
                textAreaObj = document.getElementById('obsSetting');
                textAreaObj.value = this[this.obsSettings];
                this.cm = CodeMirror.fromTextArea(textAreaObj, this.cmOptions);
                this.cm.on('change',editor => {
                    value = editor.getValue();
                    if(this.isJsonString(value)){
                        this[this.obsSettings] = value;
                    }
                });
            },
            isJsonString(str) {
                try {
                    JSON.parse(str);
                } catch (e) {
                    return false;
                }
                return true;
            },
            findOutboundTraffic(o) {
                for (const otraffic of this.outboundsTraffic) {
                    if (otraffic.tag == o.tag) {
                        return sizeFormat(otraffic.up) + ' / ' + sizeFormat(otraffic.down);
                    }
                }
                return sizeFormat(0) + ' / ' + sizeFormat(0);
            },
            findOutboundAddress(o) {
                serverObj = null;
                switch(o.protocol){
                    case Protocols.VMess:
                    case Protocols.VLESS:
                        serverObj = o.settings.vnext;
                        break;
                    case Protocols.HTTP:
                    case Protocols.Socks:
                    case Protocols.Shadowsocks:
                    case Protocols.Trojan:
                        serverObj = o.settings.servers;
                        break;
                    case Protocols.DNS:
                        return [o.settings.address + ':' + o.settings.port];
                        case Protocols.Wireguard:
                        return o.settings.peers.map(peer => peer.endpoint);
                    default:
                        return null;
                }
                return serverObj ? serverObj.map(obj => obj.address + ':' + obj.port) : null;
            },
            addOutbound(){
                outModal.show({
                    title: '{{ i18n "pages.xray.outbound.addOutbound"}}',
                    okText: '{{ i18n "pages.xray.outbound.addOutbound" }}',
                    confirm: (outbound) => {
                        outModal.loading();
                        if(outbound.tag.length > 0){
                            this.templateSettings.outbounds.push(outbound);
                            this.outboundSettings = JSON.stringify(this.templateSettings.outbounds);
                        }
                        outModal.close();
                    },
                    isEdit: false,
                    tags: this.templateSettings.outbounds.map(obj => obj.tag)
                });
            },
            editOutbound(index){
                outModal.show({
                    title: '{{ i18n "pages.xray.outbound.editOutbound"}} ' + (index+1),
                    outbound: app.templateSettings.outbounds[index],
                    confirm: (outbound) => {
                        outModal.loading();
                        this.templateSettings.outbounds[index] = outbound;
                        this.outboundSettings = JSON.stringify(this.templateSettings.outbounds);
                        outModal.close();
                    },
                    isEdit: true,
                    tags: this.outboundData.filter((o) => o.key != index ).map(obj => obj.tag)
                });
            },
            deleteOutbound(index){
                outbounds = this.templateSettings.outbounds;
                outbounds.splice(index,1);
                this.outboundSettings = JSON.stringify(outbounds);
            },
            setFirstOutbound(index){
                outbounds = this.templateSettings.outbounds;
                outbounds.splice(0, 0, outbounds.splice(index, 1)[0]);
                this.outboundSettings = JSON.stringify(outbounds);
            },
            addReverse(){
                reverseModal.show({
                    title: '{{ i18n "pages.xray.outbound.addReverse"}}',
                    okText: '{{ i18n "pages.xray.outbound.addReverse" }}',
                    confirm: (reverse, rules) => {
                        reverseModal.loading();
                        if(reverse.tag.length > 0){
                            newTemplateSettings = this.templateSettings;
                            if(newTemplateSettings.reverse == undefined) newTemplateSettings.reverse = {};
                            if(newTemplateSettings.reverse[reverse.type+'s']  == undefined) newTemplateSettings.reverse[reverse.type+'s'] = [];
                            newTemplateSettings.reverse[reverse.type+'s'].push({ tag: reverse.tag, domain: reverse.domain });
                            this.templateSettings = newTemplateSettings;

                            // Add related rules
                            this.templateSettings.routing.rules.push(...rules);
                            this.routingRuleSettings = JSON.stringify(this.templateSettings.routing.rules);
                        }
                        reverseModal.close();
                    },
                    isEdit: false
                });
            },
            editReverse(index){
                if(this.reverseData[index].type == "bridge") {
                    oldRules = this.templateSettings.routing.rules.filter(r => r.inboundTag && r.inboundTag[0] == this.reverseData[index].tag);
                } else {
                    oldRules = this.templateSettings.routing.rules.filter(r => r.outboundTag && r.outboundTag == this.reverseData[index].tag);
                }
                reverseModal.show({
                    title: '{{ i18n "pages.xray.outbound.editReverse"}} ' + (index+1),
                    reverse: this.reverseData[index],
                    rules: oldRules,
                    confirm: (reverse, rules) => {
                        reverseModal.loading();
                        if(reverse.tag.length > 0){
                            oldData = this.reverseData[index];
                            newTemplateSettings = this.templateSettings;
                            oldReverseIndex = newTemplateSettings.reverse[oldData.type+'s'].findIndex(rs => rs.tag == oldData.tag);
                            oldRuleIndex0 = oldRules.length>0 ? newTemplateSettings.routing.rules.findIndex(r => JSON.stringify(r) == JSON.stringify(oldRules[0])) : -1;
                            oldRuleIndex1 = oldRules.length==2 ? newTemplateSettings.routing.rules.findIndex(r => JSON.stringify(r) == JSON.stringify(oldRules[1])) : -1;
                            if(oldData.type == reverse.type){
                                newTemplateSettings.reverse[oldData.type + 's'][oldReverseIndex] = { tag: reverse.tag, domain: reverse.domain };
                            } else {
                                newTemplateSettings.reverse[oldData.type+'s'].splice(oldReverseIndex,1);
                                // delete empty object
                                if(newTemplateSettings.reverse[oldData.type+'s'].length == 0) Reflect.deleteProperty(newTemplateSettings.reverse, oldData.type+'s');
                                // add other type of reverse if it is not exist
                                if(!newTemplateSettings.reverse[reverse.type+'s']) newTemplateSettings.reverse[reverse.type+'s'] = [];
                                newTemplateSettings.reverse[reverse.type+'s'].push({ tag: reverse.tag, domain: reverse.domain });
                            }
                            this.templateSettings = newTemplateSettings;

                            // Adjust Rules
                            newRules = this.templateSettings.routing.rules;
                            oldRuleIndex0 != -1 ? newRules[oldRuleIndex0] = rules[0] : newRules.push(rules[0]);
                            oldRuleIndex1 != -1 ? newRules[oldRuleIndex1] = rules[1] : newRules.push(rules[1]);
                            this.routingRuleSettings = JSON.stringify(newRules);
                        }
                        reverseModal.close();
                    },
                    isEdit: true
                });
            },
            deleteReverse(index){
                oldData = this.reverseData[index];
                newTemplateSettings = this.templateSettings;
                reverseTypeObj = newTemplateSettings.reverse[oldData.type+'s'];
                realIndex = reverseTypeObj.findIndex(r => r.tag==oldData.tag && r.domain==oldData.domain);
                newTemplateSettings.reverse[oldData.type+'s'].splice(realIndex,1);

                // delete empty objects
                if(reverseTypeObj.length == 0) Reflect.deleteProperty(newTemplateSettings.reverse, oldData.type+'s');
                if(Object.keys(newTemplateSettings.reverse).length === 0) Reflect.deleteProperty(newTemplateSettings, 'reverse');

                // delete related routing rules
                newRules = newTemplateSettings.routing.rules;
                if(oldData.type == "bridge"){
                    newRules = newTemplateSettings.routing.rules.filter(r => !( r.inboundTag && r.inboundTag.length == 1 && r.inboundTag[0] == oldData.tag));
                } else if(oldData.type == "portal"){
                    newRules = newTemplateSettings.routing.rules.filter(r => r.outboundTag != oldData.tag);
                }
                newTemplateSettings.routing.rules = newRules;

                this.templateSettings = newTemplateSettings;
            },
            async refreshOutboundTraffic() {
                if (!this.refreshing) {
                    this.refreshing = true;
                    await this.getOutboundsTraffic();

                    data = []
                    if (this.templateSettings != null) {
                        this.templateSettings.outbounds.forEach((o, index) => {
                            data.push({'key': index, ...o});
                        });
                    }

                    this.outboundData = data;
                    this.refreshing = false;
                }
            },
            async resetOutboundTraffic(index) {
                let tag = "-alltags-";
                if (index >= 0) {
                    tag = this.outboundData[index].tag ? this.outboundData[index].tag : ""
                }
                const msg = await HttpUtil.post("/panel/xray/resetOutboundsTraffic", { tag: tag });
                if (msg.success) {
                    await this.refreshOutboundTraffic();
                }
            },
            addBalancer() {
                balancerModal.show({
                    title: '{{ i18n "pages.xray.balancer.addBalancer"}}',
                    okText: '{{ i18n "pages.xray.balancer.addBalancer"}}',
                    balancerTags: this.balancersData.filter((o) => !ObjectUtil.isEmpty(o.tag)).map(obj => obj.tag),
                    balancer: {
                        tag: '',
                        strategy: 'random',
                        selector: []
                    },
                    confirm: (balancer) => {
                        balancerModal.loading();
                        newTemplateSettings = this.templateSettings;
                        if (newTemplateSettings.routing.balancers == undefined) {
                            newTemplateSettings.routing.balancers = [];
                        }
                        let tmpBalancer = {
                            'tag': balancer.tag,
                            'selector': balancer.selector
                        };
                        if (balancer.strategy && balancer.strategy != 'random') {
                            tmpBalancer.strategy = {
                                'type': balancer.strategy
                            };
                            if (balancer.strategy == 'leastPing'){
                                if (!newTemplateSettings.observatory)
                                    newTemplateSettings.observatory = this.defaultObservatory;
                                if (!newTemplateSettings.observatory.subjectSelector.includes(balancer.tag))
                                    newTemplateSettings.observatory.subjectSelector.push(balancer.tag);
                            }
                            if (balancer.strategy == 'leastLoad'){
                                if (!newTemplateSettings.burstObservatory)
                                    newTemplateSettings.burstObservatory = this.defaultBurstObservatory;
                                if (!newTemplateSettings.burstObservatory.subjectSelector.includes(balancer.tag))
                                    newTemplateSettings.burstObservatory.subjectSelector.push(balancer.tag);
                            }
                        }
                        newTemplateSettings.routing.balancers.push(tmpBalancer);
                        this.templateSettings = newTemplateSettings;
                        balancerModal.close();
                        this.changeObsCode();
                    },
                    isEdit: false
                });
            },
            editBalancer(index) {
                const oldTag = this.balancersData[index].tag;
                balancerModal.show({
                    title: '{{ i18n "pages.xray.balancer.editBalancer"}}',
                    okText: '{{ i18n "sure" }}',
                    balancerTags: this.balancersData.filter((o) => !ObjectUtil.isEmpty(o.tag)).map(obj => obj.tag),
                    balancer: this.balancersData[index],
                    confirm: (balancer) => {
                        balancerModal.loading();
                        newTemplateSettings = this.templateSettings;

                        let tmpBalancer = {
                            'tag': balancer.tag,
                            'selector': balancer.selector
                        };

                        // Remove old tag
                        if (newTemplateSettings.observatory){
                            newTemplateSettings.observatory.subjectSelector = newTemplateSettings.observatory.subjectSelector.filter(s => s != oldTag);
                        }
                        if (newTemplateSettings.burstObservatory){
                            newTemplateSettings.burstObservatory.subjectSelector = newTemplateSettings.burstObservatory.subjectSelector.filter(s => s != oldTag);
                        }

                        if (balancer.strategy && balancer.strategy != 'random') {
                            tmpBalancer.strategy = {
                                'type': balancer.strategy
                            };
                            if (balancer.strategy == 'leastPing'){
                                if (!newTemplateSettings.observatory)
                                    newTemplateSettings.observatory = this.defaultObservatory;
                                if (!newTemplateSettings.observatory.subjectSelector.includes(balancer.tag))
                                    newTemplateSettings.observatory.subjectSelector.push(balancer.tag);
                            }
                            if (balancer.strategy == 'leastLoad'){
                                if (!newTemplateSettings.burstObservatory)
                                    newTemplateSettings.burstObservatory = this.defaultBurstObservatory;
                                if (!newTemplateSettings.burstObservatory.subjectSelector.includes(balancer.tag))
                                    newTemplateSettings.burstObservatory.subjectSelector.push(balancer.tag);
                            }
                        }

                        newTemplateSettings.routing.balancers[index] = tmpBalancer;
                        // change edited tag if used in rule section
                        if (oldTag != balancer.tag) {
                            newTemplateSettings.routing.rules.forEach((rule) => {
                                if (rule.balancerTag && rule.balancerTag == oldTag) {
                                    rule.balancerTag = balancer.tag;
                                }
                            });
                        }
                        this.templateSettings = newTemplateSettings;
                        balancerModal.close();
                        this.changeObsCode();
                    },
                    isEdit: true
                });
            },
            deleteBalancer(index) {
                let newTemplateSettings = { ...this.templateSettings };

                // Remove from balancers
                const removedBalancer = this.balancersData.splice(index, 1)[0];

                // Remove from settings
                let realIndex = newTemplateSettings.routing.balancers.findIndex((b) => b.tag === removedBalancer.tag);
                newTemplateSettings.routing.balancers.splice(realIndex, 1);

                // Remove tag from observatory
                if (newTemplateSettings.observatory){
                    newTemplateSettings.observatory.subjectSelector = newTemplateSettings.observatory.subjectSelector.filter(s => s != removedBalancer.tag);
                }
                if (newTemplateSettings.burstObservatory){
                    newTemplateSettings.burstObservatory.subjectSelector = newTemplateSettings.burstObservatory.subjectSelector.filter(s => s != removedBalancer.tag);
                }

                // Remove related routing rules
                newTemplateSettings.routing.rules.forEach((rule) => {
                    if (rule.balancerTag === removedBalancer.tag) {
                        delete rule.balancerTag;
                    }
                });
                
                // Update balancers property to an empty array if there are no more balancers
                if (newTemplateSettings.routing.balancers.length === 0) {
                    delete newTemplateSettings.routing.balancers;
                }
                this.templateSettings = newTemplateSettings;
                this.changeObsCode()
            },
            addDNSServer(){
                dnsModal.show({
                    title: '{{ i18n "pages.xray.dns.add" }}',
                    confirm: (dnsServer) => {
                        dnsServers = this.dnsServers;
                        dnsServers.push(dnsServer);
                        this.dnsServers = dnsServers;
                        dnsModal.close();
                    },
                    isEdit: false
                });
            },
            editDNSServer(index){
                dnsModal.show({
                    title: '{{ i18n "pages.xray.dns.edit" }} #' + (index+1),
                    dnsServer: this.dnsServers[index],
                    confirm: (dnsServer) => {
                        dnsServers = this.dnsServers;
                        dnsServers[index] = dnsServer;
                        this.dnsServers = dnsServers;
                        dnsModal.close();
                    },
                    isEdit: true
                });
            },
            deleteDNSServer(index){
                newDnsServers = this.dnsServers;
                newDnsServers.splice(index,1);
                this.dnsServers = newDnsServers;
            },
            addFakedns() {
                fakednsModal.show({
                    title: '{{ i18n "pages.xray.fakedns.add" }}',
                    confirm: (item) => {
                        fakeDns = this.fakeDns?? [];
                        fakeDns.push(item);
                        this.fakeDns = fakeDns;
                        fakednsModal.close();
                    },
                    isEdit: false
                });
            },
            editFakedns(index){
                fakednsModal.show({
                    title: '{{ i18n "pages.xray.fakedns.edit" }} #' + (index+1),
                    fakeDns: this.fakeDns[index],
                    confirm: (item) => {
                        fakeDns = this.fakeDns;
                        fakeDns[index] = item;
                        this.fakeDns = fakeDns;
                        fakednsModal.close();
                    },
                    isEdit: true
                });
            },
            deleteFakedns(index){
                fakeDns = this.fakeDns;
                fakeDns.splice(index,1);
                this.fakeDns = fakeDns;
            },
            addRule(){
                ruleModal.show({
                    title: '{{ i18n "pages.xray.rules.add"}}',
                    okText: '{{ i18n "pages.xray.rules.add" }}',
                    confirm: (rule) => {
                        ruleModal.loading();
                        if(JSON.stringify(rule).length > 3){
                            this.templateSettings.routing.rules.push(rule);
                            this.routingRuleSettings = JSON.stringify(this.templateSettings.routing.rules);
                        }
                        ruleModal.close();
                    },
                    isEdit: false
                });
            },
            editRule(index){
                ruleModal.show({
                    title: '{{ i18n "pages.xray.rules.edit"}} ' + (index+1),
                    rule: app.templateSettings.routing.rules[index],
                    confirm: (rule) => {
                        ruleModal.loading();
                        if(JSON.stringify(rule).length > 3){
                            this.templateSettings.routing.rules[index] = rule;
                            this.routingRuleSettings = JSON.stringify(this.templateSettings.routing.rules);
                        }
                        ruleModal.close();
                    },
                    isEdit: true
                });
            },
            replaceRule(old_index,new_index){
                rules = this.templateSettings.routing.rules;
                if (new_index >= rules.length) rules.push(undefined);
                rules.splice(new_index, 0, rules.splice(old_index, 1)[0]);
                this.routingRuleSettings = JSON.stringify(rules);
            },
            deleteRule(index){
                rules = this.templateSettings.routing.rules;
                rules.splice(index,1);
                this.routingRuleSettings = JSON.stringify(rules);
            },
            showWarp(){
                warpModal.show();
            }
        },
        async mounted() {
            if (window.location.protocol !== "https:") {
                this.showAlert = true;
            }
            await this.getXraySetting();
            await this.getXrayResult();
            await this.getOutboundsTraffic();
            while (true) {
                await PromiseUtil.sleep(800);
                this.saveBtnDisable = this.oldXraySetting === this.xraySetting;
            }
        },
        computed: {
            templateSettings: {
                get: function () {
                    const parsedSettings = this.xraySetting ? JSON.parse(this.xraySetting) : null;
                    let accessLogPath = "./access.log";
                    let errorLogPath = "./error.log";

                    if (parsedSettings && parsedSettings.log) {
                        if (parsedSettings.log.access && parsedSettings.log.access !== "none") {
                            accessLogPath = parsedSettings.log.access;
                        }
                        if (parsedSettings.log.error && parsedSettings.log.error !== "none") {
                            errorLogPath = parsedSettings.log.error;
                        }
                    }

                    this.access = ["none", accessLogPath];
                    this.error = ["none", errorLogPath];
                    return parsedSettings;
                },
                set: function (newValue) {
                    if (newValue && newValue.log) {
                        this.xraySetting = JSON.stringify(newValue, null, 2);
                        this.access = ["none", newValue.log.access || "./access.log"];
                        this.error = ["none", newValue.log.error || "./error.log"];
                    }
                },
            },
            inboundSettings: {
                get: function () { return this.templateSettings ? JSON.stringify(this.templateSettings.inbounds, null, 2) : null; },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.inbounds = JSON.parse(newValue);
                    this.templateSettings = newTemplateSettings;
                },
            },
            outboundSettings: {
                get: function () { return this.templateSettings ? JSON.stringify(this.templateSettings.outbounds, null, 2) : null; },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.outbounds = JSON.parse(newValue);
                    this.templateSettings = newTemplateSettings;
                },
            },
            outboundData: {
                get: function () {
                    data = []
                    if (this.templateSettings != null) {
                        this.templateSettings.outbounds.forEach((o, index) => {
                            data.push({'key': index, ...o});
                        });
                    }
                    return data;
                },
            },
            reverseData: {
                get: function () {
                    data = []
                    if (this.templateSettings != null && this.templateSettings.reverse != null) {
                        if(this.templateSettings.reverse.bridges) {
                            this.templateSettings.reverse.bridges.forEach((o, index) => {
                                data.push({'key': index, 'type':'bridge', ...o});
                            });
                        }
                        if(this.templateSettings.reverse.portals){
                            this.templateSettings.reverse.portals.forEach((o, index) => {
                                data.push({'key': index, 'type':'portal', ...o});
                            });
                        }
                    }
                    return data;
                },
            },
            routingRuleSettings: {
                get: function () { return this.templateSettings ? JSON.stringify(this.templateSettings.routing.rules, null, 2) : null; },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.routing.rules = JSON.parse(newValue);
                    this.templateSettings = newTemplateSettings;
                },
            },
            routingRuleData: {
                get: function () {
                    data = [];
                    if (this.templateSettings != null) {
                        this.templateSettings.routing.rules.forEach((r, index) => {
                            data.push({'key': index, ...r});
                        });
                        // Make rules readable
                        data.forEach(r => {
                            if(r.domain) r.domain = r.domain.join(',')
                            if(r.ip) r.ip = r.ip.join(',')
                            if(r.source) r.source = r.source.join(',');
                            if(r.user) r.user = r.user.join(',')
                            if(r.inboundTag) r.inboundTag = r.inboundTag.join(',')
                            if(r.protocol) r.protocol = r.protocol.join(',')
                            if(r.attrs) r.attrs = JSON.stringify(r.attrs, null, 2)
                        });
                    }
                    return data;
                }
            },
            balancersData: {
                get: function () {
                    data = []
                    if (this.templateSettings != null && this.templateSettings.routing != null && this.templateSettings.routing.balancers != null) {
                        this.templateSettings.routing.balancers.forEach((o, index) => {
                            data.push({
                                'key': index,
                                'tag': o.tag ? o.tag : "",
                                'strategy': o.strategy?.type ?? "random",
                                'selector': o.selector ? o.selector : []
                            });
                        });
                    }
                    return data;
                }
            },
            observatory: {
                get: function () { 
                    return this.templateSettings?.observatory ? JSON.stringify(this.templateSettings.observatory, null, 2) : null;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.observatory = JSON.parse(newValue);
                    this.templateSettings = newTemplateSettings;
                },
            },
            burstObservatory: {
                get: function () { 
                    return this.templateSettings?.burstObservatory ? JSON.stringify(this.templateSettings.burstObservatory, null, 2) : null; 
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.burstObservatory = JSON.parse(newValue);
                    this.templateSettings = newTemplateSettings;
                },
            },
            observatoryEnable: {
                get: function () { return this.templateSettings != null && this.templateSettings.observatory },
                set: function (v) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.observatory = v ? this.defaultObservatory : undefined;
                    this.templateSettings = newTemplateSettings;
                }
            },
            burstObservatoryEnable: {
                get: function () { return this.templateSettings != null && this.templateSettings.burstObservatory },
                set: function (v) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.burstObservatory = v ? this.defaultBurstObservatory : undefined;
                    this.templateSettings = newTemplateSettings;
                }
            },
            freedomStrategy: {
                get: function () {
                    if (!this.templateSettings) return "AsIs";
                    freedomOutbound = this.templateSettings.outbounds.find((o) => o.protocol === "freedom" && o.tag == "direct");
                    if (!freedomOutbound) return "AsIs";
                    if (!freedomOutbound.settings || !freedomOutbound.settings.domainStrategy) return "AsIs";
                    return freedomOutbound.settings.domainStrategy;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    freedomOutboundIndex = newTemplateSettings.outbounds.findIndex((o) => o.protocol === "freedom" && o.tag == "direct");
                    if(freedomOutboundIndex == -1){
                        newTemplateSettings.outbounds.push({protocol: "freedom", tag: "direct", settings: { "domainStrategy": newValue }});
                    } else if (!newTemplateSettings.outbounds[freedomOutboundIndex].settings) {
                        newTemplateSettings.outbounds[freedomOutboundIndex].settings = {"domainStrategy": newValue};
                    } else {
                        newTemplateSettings.outbounds[freedomOutboundIndex].settings.domainStrategy = newValue;
                    }
                    this.templateSettings = newTemplateSettings;
                }
            },
            routingStrategy: {
                get: function () {
                    if (!this.templateSettings || !this.templateSettings.routing || !this.templateSettings.routing.domainStrategy) return "AsIs";
                    return this.templateSettings.routing.domainStrategy;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.routing.domainStrategy = newValue;
                    this.templateSettings = newTemplateSettings;
                }
            },
            setLogLevel: {
                get: function () {
                    if (!this.templateSettings || !this.templateSettings.log || !this.templateSettings.log.loglevel) return "warning";
                    return this.templateSettings.log.loglevel;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.log.loglevel = newValue;
                    this.templateSettings = newTemplateSettings;
                }
            },
            accessLog: {
                get: function () {
                    if (!this.templateSettings || !this.templateSettings.log || !this.templateSettings.log.access) return "";
                    return this.templateSettings.log.access;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.log.access = newValue;
                    this.templateSettings = newTemplateSettings;
                }
            },
            errorLog: {
                get: function () {
                    if (!this.templateSettings || !this.templateSettings.log || !this.templateSettings.log.error) return "";
                    return this.templateSettings.log.error;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.log.error = newValue;
                    this.templateSettings = newTemplateSettings;
                }
            },
            blockedIPs: {
                get: function () {
                    return this.templateRuleGetter({ outboundTag: "blocked", property: "ip" });
                },
                set: function (newValue) {
                    this.templateRuleSetter({ outboundTag: "blocked", property: "ip", data: newValue });
                }
            },
            blockedDomains: {
                get: function () {
                    return this.templateRuleGetter({ outboundTag: "blocked", property: "domain" });
                },
                set: function (newValue) {
                    this.templateRuleSetter({ outboundTag: "blocked", property: "domain", data: newValue });
                }
            },
            blockedProtocols: {
                get: function () {
                    return this.templateRuleGetter({ outboundTag: "blocked", property: "protocol" });
                },
                set: function (newValue) {
                    this.templateRuleSetter({ outboundTag: "blocked", property: "protocol", data: newValue });
                }
            },
            directIPs: {
                get: function () {
                    return this.templateRuleGetter({ outboundTag: "direct", property: "ip" });
                },
                set: function (newValue) {
                    this.templateRuleSetter({ outboundTag: "direct", property: "ip", data: newValue });
                    this.syncRulesWithOutbound("direct", this.directSettings);
                }
            },
            directDomains: {
                get: function () {
                    return this.templateRuleGetter({ outboundTag: "direct", property: "domain" });
                },
                set: function (newValue) {
                    this.templateRuleSetter({ outboundTag: "direct", property: "domain", data: newValue });
                    this.syncRulesWithOutbound("direct", this.directSettings);
                }
            },
            ipv4Domains: {
                get: function () {
                    return this.templateRuleGetter({ outboundTag: "IPv4", property: "domain" });
                },
                set: function (newValue) {
                    this.templateRuleSetter({ outboundTag: "IPv4", property: "domain", data: newValue });
                    this.syncRulesWithOutbound("IPv4", this.ipv4Settings);
                }
            },
            warpDomains: {
                get: function () {
                    return this.templateRuleGetter({ outboundTag: "warp", property: "domain" });
                },
                set: function (newValue) {
                    this.templateRuleSetter({ outboundTag: "warp", property: "domain", data: newValue });
                }
            },
            torrentSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.protocols.bittorrent, this.blockedProtocols);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedProtocols = [...this.blockedProtocols, ...this.settingsData.protocols.bittorrent];
                    } else {
                        this.blockedProtocols = this.blockedProtocols.filter(data => !this.settingsData.protocols.bittorrent.includes(data));
                    }
                },
            },
            privateIpSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.local, this.blockedIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedIPs = [...this.blockedIPs, ...this.settingsData.ips.local];
                    } else {
                        this.blockedIPs = this.blockedIPs.filter(data => !this.settingsData.ips.local.includes(data));
                    }
                },
            },
            AdsSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.ads, this.blockedDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedDomains = [...this.blockedDomains, ...this.settingsData.domains.ads];
                    } else {
                        this.blockedDomains = this.blockedDomains.filter(data => !this.settingsData.domains.ads.includes(data));
                    }
                },
            },
            SecuritySettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.security, this.blockedDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedDomains = [...this.blockedDomains, ...this.settingsData.domains.security];
                    } else {
                        this.blockedDomains = this.blockedDomains.filter(data => !this.settingsData.domains.security.includes(data));
                    }
                },
            },
            SpeedTestSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.speedtest, this.blockedDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedDomains = [...this.blockedDomains, ...this.settingsData.domains.speedtest];
                    } else {
                        this.blockedDomains = this.blockedDomains.filter(data => !this.settingsData.domains.speedtest.includes(data));
                    }
                },
            },
            familyProtectSettings: {
                get: function () {
                    if (!this.templateSettings || !this.templateSettings.dns || !this.templateSettings.dns.servers) return false;
                    return doAllItemsExist(this.settingsData.familyProtectDNS.servers, this.templateSettings.dns.servers);
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    if (newValue) {
                        newTemplateSettings.dns = this.settingsData.familyProtectDNS;
                    } else {
                        newTemplateSettings.dns.servers = newTemplateSettings.dns?.servers?.filter(data => !this.settingsData.familyProtectDNS.servers.includes(data))
                    }
                    this.templateSettings = newTemplateSettings;
                },
            },
            GoogleIPv4Settings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.google, this.ipv4Domains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.ipv4Domains = [...this.ipv4Domains, ...this.settingsData.domains.google];
                    } else {
                        this.ipv4Domains = this.ipv4Domains.filter(data => !this.settingsData.domains.google.includes(data));
                    }
                },
            },
            NetflixIPv4Settings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.netflix, this.ipv4Domains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.ipv4Domains = [...this.ipv4Domains, ...this.settingsData.domains.netflix];
                    } else {
                        this.ipv4Domains = this.ipv4Domains.filter(data => !this.settingsData.domains.netflix.includes(data));
                    }
                },
            },
            IRIpSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.ir, this.blockedIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedIPs = [...this.blockedIPs, ...this.settingsData.ips.ir];
                    } else {
                        this.blockedIPs = this.blockedIPs.filter(data => !this.settingsData.ips.ir.includes(data));
                    }
                }
            },
            IRDomainSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.ir, this.blockedDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedDomains = [...this.blockedDomains, ...this.settingsData.domains.ir];
                    } else {
                        this.blockedDomains = this.blockedDomains.filter(data => !this.settingsData.domains.ir.includes(data));
                    }
                }
            },
            ChinaIpSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.cn, this.blockedIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedIPs = [...this.blockedIPs, ...this.settingsData.ips.cn];
                    } else {
                        this.blockedIPs = this.blockedIPs.filter(data => !this.settingsData.ips.cn.includes(data));
                    }
                }
            },
            ChinaDomainSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.cn, this.blockedDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedDomains = [...this.blockedDomains, ...this.settingsData.domains.cn];
                    } else {
                        this.blockedDomains = this.blockedDomains.filter(data => !this.settingsData.domains.cn.includes(data));
                    }
                }
            },
            RussiaIpSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.ru, this.blockedIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedIPs = [...this.blockedIPs, ...this.settingsData.ips.ru];
                    } else {
                        this.blockedIPs = this.blockedIPs.filter(data => !this.settingsData.ips.ru.includes(data));
                    }
                }
            },
            RussiaDomainSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.ru, this.blockedDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedDomains = [...this.blockedDomains, ...this.settingsData.domains.ru];
                    } else {
                        this.blockedDomains = this.blockedDomains.filter(data => !this.settingsData.domains.ru.includes(data));
                    }
                }
            },
            VNIpSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.vn, this.blockedIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedIPs = [...this.blockedIPs, ...this.settingsData.ips.vn];
                    } else {
                        this.blockedIPs = this.blockedIPs.filter(data => !this.settingsData.ips.vn.includes(data));
                    }
                }
            },
            VNDomainSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.vn, this.blockedDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.blockedDomains = [...this.blockedDomains, ...this.settingsData.domains.vn];
                    } else {
                        this.blockedDomains = this.blockedDomains.filter(data => !this.settingsData.domains.vn.includes(data));
                    }
                }
            },
            IRIpDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.ir, this.directIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directIPs = [...this.directIPs, ...this.settingsData.ips.ir];
                    } else {
                        this.directIPs = this.directIPs.filter(data => !this.settingsData.ips.ir.includes(data));
                    }
                }
            },
            IRDomainDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.ir, this.directDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directDomains = [...this.directDomains, ...this.settingsData.domains.ir];
                    } else {
                        this.directDomains = this.directDomains.filter(data => !this.settingsData.domains.ir.includes(data));
                    }
                }
            },
            ChinaIpDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.cn, this.directIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directIPs = [...this.directIPs, ...this.settingsData.ips.cn];
                    } else {
                        this.directIPs = this.directIPs.filter(data => !this.settingsData.ips.cn.includes(data));
                    }
                }
            },
            ChinaDomainDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.cn, this.directDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directDomains = [...this.directDomains, ...this.settingsData.domains.cn];
                    } else {
                        this.directDomains = this.directDomains.filter(data => !this.settingsData.domains.cn.includes(data));
                    }
                }
            },
            RussiaIpDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.ru, this.directIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directIPs = [...this.directIPs, ...this.settingsData.ips.ru];
                    } else {
                        this.directIPs = this.directIPs.filter(data => !this.settingsData.ips.ru.includes(data));
                    }
                }
            },
            RussiaDomainDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.ru, this.directDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directDomains = [...this.directDomains, ...this.settingsData.domains.ru];
                    } else {
                        this.directDomains = this.directDomains.filter(data => !this.settingsData.domains.ru.includes(data));
                    }
                }
            },
            VNIpDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.ips.vn, this.directIPs);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directIPs = [...this.directIPs, ...this.settingsData.ips.vn];
                    } else {
                        this.directIPs = this.directIPs.filter(data => !this.settingsData.ips.vn.includes(data));
                    }
                }
            },
            VNDomainDirectSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.vn, this.directDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.directDomains = [...this.directDomains, ...this.settingsData.domains.vn];
                    } else {
                        this.directDomains = this.directDomains.filter(data => !this.settingsData.domains.vn.includes(data));
                    }
                }
            },
            WarpExist: {
                get: function() {
                    return this.templateSettings ? this.templateSettings.outbounds.findIndex((o) => o.tag == "warp")>=0  : false;
                },
            },
            GoogleWARPSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.google, this.warpDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.warpDomains = [...this.warpDomains, ...this.settingsData.domains.google];
                    } else {
                        this.warpDomains = this.warpDomains.filter(data => !this.settingsData.domains.google.includes(data));
                    }
                },
            },
            OpenAIWARPSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.openai, this.warpDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.warpDomains = [...this.warpDomains, ...this.settingsData.domains.openai];
                    } else {
                        this.warpDomains = this.warpDomains.filter(data => !this.settingsData.domains.openai.includes(data));
                    }
                },
            },
            NetflixWARPSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.netflix, this.warpDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.warpDomains = [...this.warpDomains, ...this.settingsData.domains.netflix];
                    } else {
                        this.warpDomains = this.warpDomains.filter(data => !this.settingsData.domains.netflix.includes(data));
                    }
                },
            },
            MetaWARPSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.meta, this.warpDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.warpDomains = [...this.warpDomains, ...this.settingsData.domains.meta];
                    } else {
                        this.warpDomains = this.warpDomains.filter(data => !this.settingsData.domains.meta.includes(data));
                    }
                },
            },
            AppleWARPSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.apple, this.warpDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.warpDomains = [...this.warpDomains, ...this.settingsData.domains.apple];
                    } else {
                        this.warpDomains = this.warpDomains.filter(data => !this.settingsData.domains.apple.includes(data));
                    }
                },
            },
            RedditWARPSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.reddit, this.warpDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.warpDomains = [...this.warpDomains, ...this.settingsData.domains.reddit];
                    } else {
                        this.warpDomains = this.warpDomains.filter(data => !this.settingsData.domains.reddit.includes(data));
                    }
                },
            },
            SpotifyWARPSettings: {
                get: function () {
                    return doAllItemsExist(this.settingsData.domains.spotify, this.warpDomains);
                },
                set: function (newValue) {
                    if (newValue) {
                        this.warpDomains = [...this.warpDomains, ...this.settingsData.domains.spotify];
                    } else {
                        this.warpDomains = this.warpDomains.filter(data => !this.settingsData.domains.spotify.includes(data));
                    }
                },
            },
            enableDNS: {
                get: function () {
                    return this.templateSettings ? this.templateSettings.dns != null : false;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    if (newValue) {
                        newTemplateSettings.dns = { servers: [], queryStrategy: "UseIP", tag: "dns_inbound" };
                        newTemplateSettings.fakedns = null; 
                    } else {
                        delete newTemplateSettings.dns;
                        delete newTemplateSettings.fakedns;
                    }
                    this.templateSettings = newTemplateSettings;
                }
            },
            dnsTag: {
                get: function () {
                    return this.enableDNS ? this.templateSettings.dns.tag : "";
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.dns.tag =  newValue;
                    this.templateSettings = newTemplateSettings;
                }
            },
            dnsStrategy: {
                get: function () {
                    return this.enableDNS ? this.templateSettings.dns.queryStrategy : null;
                },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.dns.queryStrategy =  newValue;
                    this.templateSettings = newTemplateSettings;
                }
            },
            dnsServers: {
                get: function () { return this.enableDNS ? this.templateSettings.dns.servers : []; },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    newTemplateSettings.dns.servers =  newValue;
                    this.templateSettings = newTemplateSettings;
                }
            },
            fakeDns: {
                get: function () { return this.templateSettings && this.templateSettings.fakedns ? this.templateSettings.fakedns : []; },
                set: function (newValue) {
                    newTemplateSettings = this.templateSettings;
                    if (this.enableDNS) {
                        newTemplateSettings.fakedns = newValue.length > 0 ? newValue : null;
                    } else {
                        delete newTemplateSettings.fakedns;
                    }
                    this.templateSettings = newTemplateSettings;
                }
            }
        },
    });
</script>
</body>
</html>
